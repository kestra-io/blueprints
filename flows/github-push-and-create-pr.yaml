id: github-push-create-pr
namespace: system

inputs:
  - id: dev_branch
    type: STRING
    defaults: dev

  - id: namespace
    type: STRING
    defaults: example

variables:
  github_repo: username/repo-name

tasks:
  - id: push_flows
    type: io.kestra.plugin.git.PushFlows
    branch: "{{ inputs.dev_branch }}"
    sourceNamespace: "{{ inputs.namespace }}"
    targetNamespace: "{{ inputs.namespace }}"
    flows: "*"
    gitDirectory: _flows
    url: "https://github.com/{{ vars.github_repo }}"
    username: "{{ secret('GITHUB_USERNAME') }}"
    password: "{{ secret('GITHUB_ACCESS_TOKEN') }}"
    commitMessage: "Add flows - {{ execution.id }}" 

  - id: push_ns_files
    type: io.kestra.plugin.git.PushNamespaceFiles
    branch: "{{ inputs.dev_branch }}"
    namespace: "{{ inputs.namespace }}"
    gitDirectory: _files
    url: "https://github.com/{{ vars.github_repo }}"
    username: "{{ secret('GITHUB_USERNAME') }}"
    password: "{{ secret('GITHUB_ACCESS_TOKEN') }}"
    commitMessage: "Add files - {{ execution.id }}"

  - id: create_pr
    type: io.kestra.plugin.github.pulls.Create
    sourceBranch: "{{ inputs.dev_branch }}"
    targetBranch: main
    repository: "{{ vars.github_repo }}"
    oauthToken: "{{ secret('GITHUB_ACCESS_TOKEN') }}"
    title: "Merge flows into main"
    body: "Request to merge changes from develop into main"

  - id: notify_team
    type: io.kestra.plugin.slack.SlackIncomingWebhook
    url: "{{ secret('SLACK_WEBHOOK') }}"
    payload: |
      {
        "text": "New Pull Request to review: {{ outputs.create_pr.pullRequestUrl }}"
      }

extend:
  title: "Dev to Prod: Push Flows and Files to GitHub and Create a Pull Request to merge into `main`" 
  description: |
    This flow pushes your flows and files in Kestra to a development branch, then immediately opens a Pull Request for review to merge into a main branch.

    - **Push Flows:** Exports all flow YAMLs from your Kestra namespace to a specific GitHub directory.
    - **Push Files:** Pushes internal namespace files (scripts, configurations, etc.) to a specific GitHub directory.
    - **Automated PR:** Opens a Pull Request from your `dev` branch to `main` to trigger your team's review process.
    - **Notify Team:** Send a Slack message with a link to the PR for your team' to review.

    Ideal for developers who want to move their work from Kestra into a version-controlled repository without manual export/import steps.
  tags:
    - Infrastructure
    - System
  ee: false
  demo: false
  meta_description: Automatically push Kestra flows and files to GitHub and create a Pull Request to merge changes into the main branch.
