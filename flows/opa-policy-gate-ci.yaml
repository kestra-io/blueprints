id: opa-policy-gate-ci
namespace: company.security

tasks:
  - id: policy_gate
    type: io.kestra.plugin.core.flow.WorkingDirectory
    tasks:
      - id: upload_policy
        type: io.kestra.plugin.ee.opa.policy.Upload
        description: Upload the CI guardrails Rego policy to OPA (creates/updates the policy).
        url: "{{ secret('OPA_URL') }}"
        token: "{{ secret('OPA_TOKEN') }}"
        policyId: "ci-guardrails"
        policy: |
          package ci.guardrails

          deny contains msg if {
            some f in input.files
            f.kind == "Deployment"
            f.replicas < 2
            msg := sprintf("%s: Kubernetes Deployment replicas must be >= 2", [f.path])
          }

          deny contains msg if {
            some f in input.files
            f.kind == "Terraform"
            f.uses_public_s3 == true
            msg := sprintf("%s: Public S3 buckets are not allowed", [f.path])
          }

          allow if {
            count(deny) == 0
          }

      - id: evaluate_policy
        type: io.kestra.plugin.ee.opa.policy.Evaluate
        description: Evaluate the change set against the uploaded policy (fail if denied).
        url: "{{ secret('OPA_URL') }}"
        token: "{{ secret('OPA_TOKEN') }}"
        policyPath: "ci/guardrails"
        input:
          files:
            - path: "k8s/deploy.yaml"
              kind: "Deployment"
              replicas: 1
            - path: "terraform/main.tf"
              kind: "Terraform"
              uses_public_s3: true
        metrics: true
        explain: "notes"

      - id: fail_if_denied
        type: io.kestra.plugin.core.flow.If
        condition: "{{ outputs.evaluate_policy.result.deny != null and (outputs.evaluate_policy.result.deny | length) > 0 }}"
        then:
          - id: fail
            type: io.kestra.plugin.core.execution.Fail
            errorMessage: "OPA policy denied: {{ outputs.evaluate_policy.result.deny }}"
        else:
          - id: ok
            type: io.kestra.plugin.core.log.Log
            message: "OPA policy passed"

extend:
  shortDescription: "Use OPA as a CI/CD policy gate: upload Rego guardrails, evaluate changes, and fail the workflow when denied."
  title: Enforce CI/CD guardrails with OPA (Rego) policy gate
  description: |
    This workflow **uses Open Policy Agent (OPA) as a policy gate** for CI/CD-style validations
    on infrastructure and configuration changes (e.g., Kubernetes manifests, Terraform).

    The flow performs the following actions:
      - Uploads (creates/updates) a Rego policy in OPA using the Kestra OPA plugin
      - Evaluates a change set payload against `data.ci.guardrails`
      - Fails the workflow if the policy returns any `deny` messages
      - Emits metrics and explanation output for observability and debugging

    This pattern is ideal for:
      - CI checks for Kubernetes/Terraform guardrails
      - Enforcing security and compliance rules before deploy
      - Centralizing policy logic in Rego with consistent evaluations
      - Adding auditable, version-controlled approvals/denials to pipelines

    Secrets required:
      - `OPA_URL` (e.g., http://localhost:8181)
      - `OPA_TOKEN` (Bearer token if OPA is protected)

  tags:
    - Infrastructure
  ee: true
  demo: false
  meta_description: |
    Upload and evaluate OPA (Rego) policies in Kestra to enforce CI/CD guardrails,
    failing workflows when changes violate security or compliance rules.
