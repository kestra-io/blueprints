id: argocd-app-management
namespace: company.team
description: |
  Manage an Argo CD application end to end: create the Application manifest
  with kubectl, check its status, run a sync, and verify status afterward.

tasks:
  - id: create_argocd_app
    type: io.kestra.plugin.kubernetes.kubectl.Apply
    description: Apply the Argo CD Application manifest to the cluster.
    connection:
      masterUrl: "{{ secret('K8S_MASTER_URL') }}"
      oauthToken: "{{ secret('K8S_TOKEN') }}"
    namespace: default
    spec: |
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: my-argocd-app
      spec:
        project: default
        source:
          repoURL: https://github.com/argoproj/argocd-example-apps.git
          targetRevision: HEAD
          path: guestbook
        destination:
          server: https://kubernetes.default.svc
          namespace: default

  - id: get_argocd_app_status_before_sync
    type: io.kestra.plugin.argocd.app.Status
    description: Fetch the application status before running synchronization.
    application: my-argocd-app

  - id: sync_argocd_app
    type: io.kestra.plugin.argocd.app.Sync
    description: Synchronize the application and prune any out-of-band resources.
    application: my-argocd-app
    prune: true
    revision: HEAD

  - id: get_argocd_app_status_after_sync
    type: io.kestra.plugin.argocd.app.Status
    description: Fetch the application status after synchronization completes.
    application: my-argocd-app

pluginDefaults:
  - type: io.kestra.plugin.argocd.app.Status
    values:
      server: "{{ secret('ARGOCD_SERVER') }}"
      token: "{{ secret('ARGOCD_TOKEN') }}"
  - type: io.kestra.plugin.argocd.app.Sync
    values:
      server: "{{ secret('ARGOCD_SERVER') }}"
      token: "{{ secret('ARGOCD_TOKEN') }}"

extend:
  shortDescription: "Create an Argo CD Application, sync it, and capture statuses before and after reconciliation."
  title: Manage an Argo CD Application with Sync Verification
  description: |
    This blueprint provisions and manages an Argo CD application inside a Kubernetes
    cluster. It applies the Application manifest, captures status before syncing,
    performs a sync (with prune), and verifies status afterward.

    Prerequisites:
      - Secrets:
        - K8S_MASTER_URL: Kubernetes API server URL for kubectl access.
        - K8S_TOKEN: Bearer token with permissions to create Argo CD Applications.
        - ARGOCD_SERVER: Argo CD API endpoint (for example, https://argocd.example.com).
        - ARGOCD_TOKEN: Argo CD API token with access to the target application.
      - Argo CD installed in the target cluster.

    Quick start:
      1. Set the four secrets above in your Kestra namespace.
      2. Adjust the Application name, repoURL, and path if you want to deploy a different app.
      3. Upload and run the flow to create the Application, sync it, and inspect the before/after statuses.

    Outputs:
      - outputs.get_argocd_app_status_before_sync: Argo CD status payload before sync.
      - outputs.get_argocd_app_status_after_sync: Argo CD status payload after sync.
      - outputs.create_argocd_app: kubectl apply response for the Application manifest.

    Notes:
      - The sync task uses `prune: true` to remove resources not defined in Git.
      - Destination defaults to the in-cluster API server; change if deploying to another cluster.
  tags:
    - Infrastructure
  ee: false
  demo: false
  meta_description: Create and sync an Argo CD Application with kubectl, then check its status before and after reconciliation.
