id: data-pipeline-assets
namespace: kestra.company

tasks:
  - id: create_staging_layer_asset
    type: io.kestra.plugin.jdbc.duckdb.Query
    sql: |
      CREATE TABLE IF NOT EXISTS trips AS
      select VendorID, passenger_count, trip_distance from sample_data.nyc.taxi limit 10;
    assets:
      inputs:
        - id: sample_data.nyc.taxi
      outputs:
        - id: trips
          namespace: "{{flow.namespace}}"
          type: io.kestra.plugin.ee.assets.Table
          metadata:
            model_layer: staging

  - id: for_each
    type: io.kestra.plugin.core.flow.ForEach
    values:
      - passenger_count
      - trip_distance
    tasks:
      - id: create_mart_layer_asset
        type: io.kestra.plugin.jdbc.duckdb.Query
        sql: SELECT AVG({{taskrun.value}}) AS avg_{{taskrun.value}} FROM trips;
        assets:
          inputs:
            - id: trips
          outputs:
            - id: avg_{{taskrun.value}}
              type: io.kestra.plugin.ee.assets.Table
              namespace: "{{flow.namespace}}"
              metadata:
                model_layer: mart

pluginDefaults:
  - type: io.kestra.plugin.jdbc.duckdb
    values:
      url: "jdbc:duckdb:md:my_db?motherduck_token={{ secret('MOTHERDUCK_TOKEN') }}"
      fetchType: STORE

extend:
  title: Data Lineage and Asset Management with DuckDB
  description: |
    This flow demonstrates:
    - **External Asset Reference** - sample_data.nyc.taxi is referenced as an input, representing an external data source
    - **Staging Layer Creation** - The trips table is created and registered as an Table type asset with model_layer: staging metadata
    - **Mart Layer Generation** - Multiple mart tables (avg_passenger_count, avg_trip_distance) are created from the staging layer
    - **Automatic Dependency Graph** - Kestra automatically tracks that mart tables depend on the staging table, which depends on the external source

  tags:
    - Core
    - Data
  ee: true
  demo: false
  meta_description: This blueprint demonstrates building staging and mart layers 
    using DuckDB with full lineage visualization.
