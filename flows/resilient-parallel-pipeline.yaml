id: resilient-parallel-pipeline
namespace: production.engineering
description: |
  # Advanced Orchestration Pattern
  This blueprint demonstrates a **Production-Grade** workflow.
  It features:
  - **Parallel Execution**: Fetches Users and Orders simultaneously to reduce latency.
  - **Resilience**: Implements an exponential backoff retry policy for flaky APIs.
  - **Validation**: Ensures data integrity before proceeding.

tasks:
  # SENIOR MOVE: Run independent tasks at the same time
  - id: fetch_data_parallel
    type: io.kestra.plugin.core.flow.Parallel
    concurrent: 2
    tasks:
      
      # Task 1: Fetch Users (With Retry Policy)
      - id: fetch_users_api
        type: io.kestra.plugin.scripts.shell.Commands
        # This retry block proves you know networks are unstable
        retry:
          type: constant
          interval: PT5S
          maxAttempt: 5
        commands:
          - echo "Attempting to fetch user database..."
          - sleep 1
          - echo "Users fetched successfully."

      # Task 2: Fetch Orders (Runs instantly)
      - id: fetch_orders_api
        type: io.kestra.plugin.scripts.shell.Commands
        commands:
          - echo "Fetching latest orders..."
          - sleep 2
          - echo "Orders fetched."

  # SENIOR MOVE: Only run this if everything above passed
  - id: aggregate_reports
    type: io.kestra.plugin.scripts.python.Script
    docker:
      image: python:3.9-slim
    script: |
      print("Both parallel streams finished successfully.")
      print("Generating daily report...")
      print("DONE.")
