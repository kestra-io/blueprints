id: nutanix_safe_patching_workflow
namespace: company.team
description: Provision a Nutanix AHV VM, emit VM/snapshot assets, apply OS updates, and rollback automatically on failure.

inputs:
  - id: vm_name
    type: STRING
    defaults: "prod-web-server-01"

tasks:
  - id: provision_vm
    type: io.kestra.plugin.ee.nutanix.ahv.CreateVm
    wait: true
    vm:
      name: "{{ inputs.vm_name }}"
      description: "VM created by Kestra"
      cluster:
        extId: "{{ secret('NUTANIX_CLUSTER_EXT_ID') }}"
      resources:
        numSockets: 1
        numCoresPerSocket: 2
        memorySizeBytes: 2147483648
        disks: []
    assets:
      outputs:
        - id: "{{ inputs.vm_name }}"
          type: io.kestra.plugin.ee.assets.VirtualMachine
          metadata:
            provider: nutanix
            env: production

  - id: safe_patching_block
    type: io.kestra.plugin.core.flow.Sequential
    tasks:
      - id: pre_patch_snapshot
        type: io.kestra.plugin.ee.nutanix.snapshot.CreateVmSnapshot
        vmExtId: "{{ outputs.provision_vm.vmExtId }}"
        snapshotName: "pre_patch_{{ execution.id }}"
        assets:
          inputs:
            - id: "{{ inputs.vm_name }}"
          outputs:
            - id: "snapshot-{{ execution.id }}"
              type: io.kestra.plugin.ee.assets.Snapshot

      - id: apply_updates
        type: io.kestra.plugin.scripts.shell.Commands
        commands:
          - ssh -o StrictHostKeyChecking=no admin@{{ outputs.provision_vm.vmIpAddresses[0] }} "sudo apt update && sudo apt upgrade -y && sudo reboot"

      - id: wait_for_boot
        type: io.kestra.plugin.core.flow.Pause
        delay: PT1M

      - id: health_check
        type: io.kestra.plugin.core.http.Request
        uri: "http://{{ outputs.provision_vm.vmIpAddresses[0] }}/health"
        method: "GET"

      - id: notify_success
        type: io.kestra.plugin.notifications.slack.SlackIncomingWebhook
        url: "{{ secret('SLACK_WEBHOOK') }}"
        payload: |
          {
            "text": ":white_check_mark: *Patching Succeeded!* VM `{{ inputs.vm_name }}` has been successfully patched."
          }
    errors:
      - id: rollback
        type: io.kestra.plugin.ee.nutanix.snapshot.RestoreVmSnapshot
        snapshotExtId: "{{ outputs.safe_patching_block.pre_patch_snapshot.snapshotExtId }}"
      - id: notify_oncall
        type: io.kestra.plugin.notifications.slack.SlackIncomingWebhook
        url: "{{ secret('SLACK_WEBHOOK') }}"
        payload: |
          {
            "text": ":alert: *Patching Failed!* VM `{{ inputs.vm_name }}` has been rolled back to its pre-patch state."
          }

  - id: cleanup_snapshot
    type: io.kestra.plugin.ee.nutanix.snapshot.DeleteVmSnapshot
    snapshotExtId: "{{ outputs.safe_patching_block.pre_patch_snapshot.snapshotExtId }}"

pluginDefaults:
  - type: io.kestra.plugin.ee.nutanix
    values:
      host: "{{ secret('NUTANIX_HOST') }}"
      token: "{{ secret('NUTANIX_TOKEN') }}"

extend:
  shortDescription: "Provision a Nutanix VM, emit VM & snapshot assets, patch via SSH, and rollback automatically on failure."
  title: Nutanix safe patching with snapshot rollback
  description: |
    This flow provisions a Nutanix AHV VM and emits a VM asset, then creates a
    pre-patch snapshot (emitting a snapshot asset), runs OS updates over SSH,
    waits for reboot, performs a health check, and notifies Slack on success.
    
    If any task fails, it automatically restores the snapshot and alerts
    on-call. 
    
    Provide Nutanix cluster credentials (`NUTANIX_HOST`,
    `NUTANIX_TOKEN`, `NUTANIX_CLUSTER_EXT_ID`) and Slack webhook URL
    (`SLACK_WEBHOOK`).
  tags:
    - Infrastructure
  ee: true
  demo: false
  meta_description: "Nutanix safe patching workflow that snapshots, updates, health-checks, and rolls back on failure with Slack notifications."
