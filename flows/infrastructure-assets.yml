id: infra_assets
namespace: kestra.company

inputs:
  - id: teams
    type: MULTISELECT
    values:
      - Business
      - Data
      - Finance
      - Product

tasks:
  - id: for_each
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ inputs.teams }}"
    tasks:
      - id: create_bucket
        type: io.kestra.plugin.aws.cli.AwsCLI
        commands:
          - aws s3 mb s3://kestra-{{ taskrun.value | slugify }}-bucket
        assets:
          outputs:
            - id: kestra-{{ taskrun.value | slugify }}-bucket
              type: AWS_BUCKET
              metadata:
                provider: s3
                address: s3://kestra-{{ taskrun.value | slugify }}-bucket

pluginDefaults:
  - type: io.kestra.plugin.aws
    values:
      accessKeyId: "{{ secret('AWS_ACCESS_KEY') }}"
      secretKeyId: "{{ secret('AWS_SECRET_ACCESS_KEY') }}"
      region: "{{ secret('AWS_REGION') }}"
      allowFailure: true

extend:
  title: Govern cloud infrastructure with Kestra Assets — automated S3 bucket provisioning by team
  description: |
    This blueprint demonstrates how to **provision cloud infrastructure as code**
    while turning infrastructure resources into **first-class, governed assets**
    using Kestra.

    It is designed for **platform, DevOps, and infrastructure teams** who want
    visibility, ownership, and traceability across shared cloud resources.

    **What this flow does:**

    - **Dynamic infrastructure provisioning**  
      Based on user-selected teams (Business, Data, Finance, Product), the flow
      automatically creates one Amazon S3 bucket per team using the AWS CLI.

    - **Infrastructure as Assets**  
      Each S3 bucket is immediately registered as an `AWS_BUCKET` asset, enriched
      with metadata such as:
        - cloud provider (AWS)
        - service (S3)
        - canonical address (`s3://…`)

      This turns ephemeral infrastructure into **discoverable, reusable assets**
      inside Kestra.

    - **Asset-based ownership and governance**  
      Once registered, these infrastructure assets can be referenced explicitly
      by downstream workflows. This creates a clear contract between:
        - platform teams (who provision infrastructure)
        - application and data teams (who consume it)

    **Downstream usage example (Data team):**

    The following flow shows how the Data team consumes its provisioned S3 bucket
    as an input asset, uploads a file, and produces a new file asset derived from
    that infrastructure:

    ```yaml
    id: upload_file
    namespace: kestra.company.data

    tasks:
      - id: download
        type: io.kestra.plugin.core.http.Download
        uri: https://raw.githubusercontent.com/kestra-io/datasets/refs/heads/main/jaffle-data/raw_customers.csv

      - id: aws_upload
        type: io.kestra.plugin.aws.s3.Upload
        bucket: kestra-data-bucket
        from: '{{ outputs.download.uri }}'
        key: raw_customer.csv
        assets:
          inputs:
            - id: kestra-data-bucket
          outputs:
            - id: raw_customer
              type: io.kestra.plugin.ee.assets.File
              metadata:
                owner: data

    pluginDefaults:
      - type: io.kestra.plugin.aws
        values:
          accessKeyId: "{{ secret('AWS_ACCESS_KEY') }}"
          secretKeyId: "{{ secret('AWS_SECRET_ACCESS_KEY') }}"
          region: "{{ secret('AWS_REGION') }}"
    ```

    **Why this pattern matters:**

    - Enables **infrastructure lineage**: know which workflows depend on which
      buckets
    - Enforces **clear ownership** across teams
    - Prevents “ghost resources” by making infrastructure visible in the asset
      catalog
    - Aligns Infrastructure as Code with **data and workflow governance**

    This approach is ideal for organizations building **multi-team platforms**
    where infrastructure must be shared safely, audited easily, and reused
    confidently.
  tags:
    - Core
    - Infrastructure
  ee: true
  demo: false
  meta_description: Provision AWS S3 buckets per team and register them as governed infrastructure assets. Track ownership, enable infrastructure lineage, and safely reuse cloud resources across workflows with Kestra Assets.

