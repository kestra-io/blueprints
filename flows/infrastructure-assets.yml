id: infra_assets
namespace: kestra.company

inputs:
  - id: teams
    type: MULTISELECT
    values:
      - Business
      - Data
      - Finance
      - Product

tasks:
  - id: for_each
    type: io.kestra.plugin.core.flow.ForEach
    values: "{{ inputs.teams }}"
    tasks:
      - id: create_bucket
        type: io.kestra.plugin.aws.cli.AwsCLI
        commands:
          - aws s3 mb s3://kestra-{{ taskrun.value | slugify }}-bucket
        assets:
          outputs:
            - id: kestra-{{ taskrun.value | slugify }}-bucket
              type: AWS_BUCKET
              metadata:
                provider: s3
                address: s3://kestra-{{ taskrun.value | slugify }}-bucket

pluginDefaults:
  - type: io.kestra.plugin.aws
    values:
      accessKeyId: "{{ secret('AWS_ACCESS_KEY') }}"
      secretKeyId: "{{ secret('AWS_SECRET_ACCESS_KEY') }}"
      region: "{{ secret('AWS_REGION') }}"
      allowFailure: true

extend:
  title: Infrastructure Assets - Team Bucket Provisioning
  description: |
    This example demonstrates how a DevOps team can provision cloud resources and track their usage across different teams.

    The flow creates S3 buckets for selected teams and registers them as assets.

    This flow dynamically creates buckets (e.g., `kestra-data-bucket`, `kestra-finance-bucket`) and 
    registers each as an `AWS_BUCKET` asset with relevant metadata.

    Once the infrastructure is provisioned, teams can reference these assets in their workflows. Here's how the Data team uses their bucket:

    ```yaml
    id: upload_file
    namespace: kestra.company.data

    tasks:
      - id: download
        type: io.kestra.plugin.core.http.Download
        uri: https://raw.githubusercontent.com/kestra-io/datasets/refs/heads/main/jaffle-data/raw_customers.csv

      - id: aws_upload
        type: io.kestra.plugin.aws.s3.Upload
        bucket: kestra-data-bucket
        from: '{{ outputs.download.uri }}'
        key: raw_customer.csv
        assets:
          inputs:
            - id: kestra-data-bucket
          outputs:
            - id: raw_customer
              type: io.kestra.plugin.ee.assets.File
              metadata:
                owner: data

    pluginDefaults:
      - type: io.kestra.plugin.aws
        values:
          accessKeyId: "{{ secret('AWS_ACCESS_KEY') }}"
          secretKeyId: "{{ secret('AWS_SECRET_ACCESS_KEY') }}"
          region: "{{ secret('AWS_REGION') }}"
    ```

  tags:
    - Core
    - Infrastructure
  ee: true
  demo: false
  meta_description: This flow creates S3 buckets for selected teams and registers them as assets.
