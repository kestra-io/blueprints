
id: python-pandas-etl
namespace: company.team

description: ETL flow for cleaning raw sales CSV data and calculating regional totals.

tasks:
  - id: extract_and_transform
    type: io.kestra.plugin.scripts.python.Script
    containerImage: python:3.12-slim
    beforeCommands:
      - pip install pandas
    script: |
      import pandas as pd
      import io

      # Raw data with some "dirty" entries
      raw_data = """order_id,region,amount,status
      101,North,150.50,completed
      102,South,200.00,pending
      103,North,50.25,completed
      104,West,300.75,completed
      105,South,,completed
      106,West,120.00,completed"""

      df = pd.read_csv(io.StringIO(raw_data))

      # Human-style cleaning: drop missing amounts and filter for completed orders
      df = df.dropna(subset=['amount'])
      df = df[df['status'] == 'completed']

      # Aggregation logic
      regional_summary = df.groupby('region')['amount'].sum().reset_index()

      print("Processing complete. Regional breakdown:")
      print(regional_summary)

      kestra_outputs = {'regional_totals': regional_summary.to_dict()}