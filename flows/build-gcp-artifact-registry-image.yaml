id: build-gcp-artifact-registry-image
namespace: company.team

tasks:
  - id: fetch_auth_token
    type: io.kestra.plugin.gcp.auth.OauthAccessToken
    projectId: your_gcp_project_id
    serviceAccount: "{{ secret('GCP_CREDS') }}"

  - id: build
    type: io.kestra.plugin.docker.Build
    dockerfile: |
      FROM python:3.10
      RUN pip install --upgrade pip
      RUN pip install --no-cache-dir kestra requests "polars[all]"
    tags:
      - europe-west3-docker.pkg.dev/your_gcp_project_id/kestra/polars:latest
    push: true
    credentials:
      username: oauth2accesstoken
      password: "{{ outputs.fetch_auth_token.accessToken.tokenValue }}"

extend:
  title: Google Cloud CI/CD: Build and Push Docker Images to Google Cloud Artifact Registry
  description: |
    This workflow implements a **Continuous Integration (CI) pipeline** that
    automatically builds Docker images and pushes them to **Google Cloud
    Artifact Registry** using secure OAuth-based authentication.

    It shows how to:

    1. Build Docker images from an inline Dockerfile or a file-based Dockerfile
       as part of a cloud-native CI/CD workflow.
    2. Authenticate to Google Cloud Artifact Registry using a short-lived OAuth
       access token generated from a GCP service account.
    3. Properly tag container images with the correct GCP region and Artifact
       Registry repository path.
    4. Push Docker images automatically for downstream deployment to
       GKE, Cloud Run, or Kubernetes.
    5. Securely manage Google Cloud credentials using Kestra secrets and
       environment variables.

    This flow is ideal for **CI/CD pipelines**, **data engineering platforms**,
    and **cloud infrastructure teams** looking to automate Docker image builds
    and container publishing on Google Cloud.
  tags:
    - Infrastructure
    - Cloud
  ee: false
  demo: false
  meta_description: |
    Automate Docker image builds and push containers to Google Cloud Artifact
    Registry with Kestra. A secure CI/CD workflow for cloud-native deployments.

