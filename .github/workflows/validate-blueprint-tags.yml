name: Validate Blueprint Tags

on:
  push:
    branches:
      - main
    paths:
      - 'flows/*.yaml'
      - 'flows/*.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'flows/*.yaml'
      - 'flows/*.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-tags:
    name: Validate Blueprint Tags
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate blueprint tags
        run: |
          #!/bin/bash
          set -e

          echo "üîç Validating blueprint tags..."
          echo "Allowed tags: Data, Infra, Business, Cloud, Core, AI, Getting Started"
          echo

          # Track files with issues
          INVALID_FILES=()
          OVER_LIMIT_FILES=()

          # Process each YAML file in flows directory
          while IFS= read -r -d '' file; do
            echo "üìÑ Checking: $file"

            # Extract tags section using Python for reliable YAML parsing
            RESULT=$(python3 -c "
          import yaml
          import sys
          import os

          file_path = '$file'
          try:
              with open(file_path, 'r') as f:
                  data = yaml.safe_load(f)

              if 'extend' in data and 'tags' in data['extend']:
                  tags = data['extend']['tags']

                  # Check for invalid tags
                  allowed_tags = ['Data', 'Infra', 'Business', 'Cloud', 'Core', 'AI', 'Getting Started']
                  invalid_tags = []
                  for tag in tags:
                      if tag not in allowed_tags:
                          invalid_tags.append(tag)

                  # Check for too many tags
                  if len(tags) > 3:
                      print(f'OVER_LIMIT:{len(tags)}:{tags}')
                  elif invalid_tags:
                      print(f'INVALID:{invalid_tags}')
                  else:
                      print('VALID')
              else:
                  print('NO_TAGS')
          except Exception as e:
              print(f'ERROR:{e}')
          ")

            # Process the result
            if [[ $RESULT == OVER_LIMIT:* ]]; then
              OVER_LIMIT_FILES+=("$file")
              echo "  ‚ùå Too many tags: $RESULT"
            elif [[ $RESULT == INVALID:* ]]; then
              INVALID_FILES+=("$file")
              echo "  ‚ùå Invalid tags: $RESULT"
            elif [[ $RESULT == VALID ]]; then
              echo "  ‚úÖ Valid"
            elif [[ $RESULT == NO_TAGS ]]; then
              echo "  ‚ö†Ô∏è  No tags found"
            else
              echo "  ‚ùì Unexpected result: $RESULT"
            fi

          done < <(find flows -name "*.yaml" -o -name "*.yml" -print0)

          echo

          # Check results
          if [ ${#INVALID_FILES[@]} -gt 0 ]; then
            echo "‚ùå Found files with invalid tags:"
            for file in "${INVALID_FILES[@]}"; do
              echo "  - $file"
            done
            exit 1
          fi

          if [ ${#OVER_LIMIT_FILES[@]} -gt 0 ]; then
            echo "‚ùå Found files with more than 3 tags:"
            for file in "${OVER_LIMIT_FILES[@]}"; do
              echo "  - $file"
            done
            exit 1
          fi

          echo "‚úÖ All blueprint tags are valid!"
